/***************************************************************************************************
Desc:	We have added denotified records into the ReusableNotification tables so that they can go through 
		the same transformation logic as the notified records. However, they are only needed for the
		LegacyExtract report and should not remain in the main table after processing
**************************************************************************************************/
CREATE PROCEDURE [dbo].[uspRemoveDenotifiedRecords]
	
AS
BEGIN TRY

    DELETE FROM [dbo].[DenotifiedRecords]


    --first add the NTBS records
	INSERT INTO [dbo].[DenotifiedRecords]
	([NotificationId]
      ,[NtbsId]
      ,[EtsId]
      ,[SourceSystem]
      ,[LtbrId]
      ,[NotificationDate]
      ,[Denotified]
      ,[DenotificationDate]
      ,[DenotificationReason]
      ,[CaseManager]
      ,[Consultant]
      ,[HospitalId]
      ,[Hospital]
      ,[TBServiceCode]
      ,[Service]
      ,[NhsNumber]
      ,[Forename]
      ,[Surname]
      ,[DateOfBirth]
      ,[Age]
      ,[Sex]
      ,[UkBorn]
      ,[EthnicGroup]
      ,[Occupation]
      ,[OccupationCategory]
      ,[BirthCountry]
      ,[UkEntryYear]
      ,[Postcode]
      ,[NoFixedAbode]
      ,[LocalAuthority]
      ,[LocalAuthorityCode]
      ,[ResidencePhecCode]
      ,[ResidencePhec]
      ,[TreatmentPhecCode]
      ,[TreatmentPhec]
      ,[SymptomOnsetDate]
      ,[PresentedDate]
      ,[OnsetToPresentationDays]
      ,[DiagnosisDate]
      ,[PresentationToDiagnosisDays]
      ,[StartOfTreatmentDate]
      ,[DiagnosisToTreatmentDays]
      ,[OnsetToTreatmentDays]
      ,[HivTestOffered]
      ,[SiteOfDisease]
      ,[AdultContactsIdentified]
      ,[ChildContactsIdentified]
      ,[TotalContactsIdentified]
      ,[AdultContactsAssessed]
      ,[ChildContactsAssessed]
      ,[TotalContactsAssessed]
      ,[AdultContactsActiveTB]
      ,[ChildContactsActiveTB]
      ,[TotalContactsActiveTB]
      ,[AdultContactsLTBI]
      ,[ChildContactsLTBI]
      ,[TotalContactsLTBI]
      ,[AdultContactsLTBITreat]
      ,[ChildContactsLTBITreat]
      ,[TotalContactsLTBITreat]
      ,[AdultContactsLTBITreatComplete]
      ,[ChildContactsLTBITreatComplete]
      ,[TotalContactsLTBITreatComplete]
      ,[PreviouslyDiagnosed]
      ,[YearsSinceDiagnosis]
      ,[PreviouslyTreated]
      ,[TreatmentInUk]
      ,[PreviousId]
      ,[BcgVaccinated]
      ,[AnySocialRiskFactor]
      ,[AlcoholMisuse]
      ,[DrugMisuse]
      ,[CurrentDrugMisuse]
      ,[DrugMisuseInLast5Years]
      ,[DrugMisuseMoreThan5YearsAgo]
      ,[Homeless]
      ,[CurrentlyHomeless]
      ,[HomelessInLast5Years]
      ,[HomelessMoreThan5YearsAgo]
      ,[Prison]
      ,[CurrentlyInPrisonOrInPrisonWhenFirstSeen]
      ,[InPrisonInLast5Years]
      ,[InPrisonMoreThan5YearsAgo]
      ,[TravelledOutsideUk]
      ,[ToHowManyCountries]
      ,[TravelCountry1]
      ,[MonthsTravelled1]
      ,[TravelCountry2]
      ,[MonthsTravelled2]
      ,[TravelCountry3]
      ,[MonthsTravelled3]
      ,[ReceivedVisitors]
      ,[FromHowManyCountries]
      ,[VisitorCountry1]
      ,[DaysVisitorsStayed1]
      ,[VisitorCountry2]
      ,[DaysVisitorsStayed2]
      ,[VisitorCountry3]
      ,[DaysVisitorsStayed3]
      ,[Diabetes]
      ,[HepatitisB]
      ,[HepatitisC]
      ,[ChronicLiverDisease]
      ,[ChronicRenalDisease]
      ,[ImmunoSuppression]
      ,[BiologicalTherapy]
      ,[Transplantation]
      ,[OtherImmunoSuppression]
      ,[CurrentSmoker]
      ,[PostMortemDiagnosis]
      ,[DidNotStartTreatment]
      ,[ShortCourse]
      ,[MdrTreatment]
      ,[MdrTreatmentDate]
      ,[TreatmentOutcome12months]
      ,[TreatmentOutcome24months]
      ,[TreatmentOutcome36months]
      ,[LastRecordedTreatmentOutcome]
      ,[DateOfDeath]
      ,[TreatmentEndDate]
      ,[NoSampleTaken]
      ,[CulturePositive]
      ,[Species]
      ,[EarliestSpecimenDate]
      ,[DrugResistanceProfile]
      ,[INH]
      ,[RIF]
      ,[EMB]
      ,[PZA]
      ,[AMINO]
      ,[QUIN]
      ,[MDR]
      ,[XDR]
      ,[DataRefreshedAt])
  
	--first do NTBS denotifieds
	SELECT 
       rn.NotificationId 
      ,rn.[NtbsId]
      ,rn.[EtsId]
      ,rn.[SourceSystem]
      ,rn.[LtbrId]
      ,rn.[NotificationDate]
      ,'Yes' AS 'Denotified' 
      ,dn.DateOfDenotification  AS 'DenotificationDate'
      ,drm.ReasonOutputName     AS 'DenotificationReason'
      ,rn.[CaseManager]
      ,rn.[Consultant]
      ,rn.[HospitalId]
      ,rn.[Hospital]
      ,rn.[TBServiceCode]
      ,rn.[Service]
      ,rn.[NhsNumber]
      ,rn.[Forename]
      ,rn.[Surname]
      ,rn.[DateOfBirth]
      ,rn.[Age]
      ,rn.[Sex]
      ,rn.[UkBorn]
      ,rn.[EthnicGroup]
      ,rn.[Occupation]
      ,rn.[OccupationCategory]
      ,rn.[BirthCountry]
      ,rn.[UkEntryYear]
      ,rn.[Postcode]
      ,rn.[NoFixedAbode]
      ,rn.[LocalAuthority]
      ,rn.[LocalAuthorityCode]
      ,rn.[ResidencePhecCode]
      ,rn.[ResidencePhec]
      ,rn.[TreatmentPhecCode]
      ,rn.[TreatmentPhec]
      ,rn.[SymptomOnsetDate]
      ,rn.[PresentedDate]
      ,rn.[OnsetToPresentationDays]
      ,rn.[DiagnosisDate]
      ,rn.[PresentationToDiagnosisDays]
      ,rn.[StartOfTreatmentDate]
      ,rn.[DiagnosisToTreatmentDays]
      ,rn.[OnsetToTreatmentDays]
      ,rn.[HivTestOffered]
      ,rn.[SiteOfDisease]
      ,rn.[AdultContactsIdentified]
      ,rn.[ChildContactsIdentified]
      ,rn.[TotalContactsIdentified]
      ,rn.[AdultContactsAssessed]
      ,rn.[ChildContactsAssessed]
      ,rn.[TotalContactsAssessed]
      ,rn.[AdultContactsActiveTB]
      ,rn.[ChildContactsActiveTB]
      ,rn.[TotalContactsActiveTB]
      ,rn.[AdultContactsLTBI]
      ,rn.[ChildContactsLTBI]
      ,rn.[TotalContactsLTBI]
      ,rn.[AdultContactsLTBITreat]
      ,rn.[ChildContactsLTBITreat]
      ,rn.[TotalContactsLTBITreat]
      ,rn.[AdultContactsLTBITreatComplete]
      ,rn.[ChildContactsLTBITreatComplete]
      ,rn.[TotalContactsLTBITreatComplete]
      ,rn.[PreviouslyDiagnosed]
      ,rn.[YearsSinceDiagnosis]
      ,rn.[PreviouslyTreated]
      ,rn.[TreatmentInUk]
      ,rn.[PreviousId]
      ,rn.[BcgVaccinated]
      ,rn.[AnySocialRiskFactor]
      ,rn.[AlcoholMisuse]
      ,rn.[DrugMisuse]
      ,rn.[CurrentDrugMisuse]
      ,rn.[DrugMisuseInLast5Years]
      ,rn.[DrugMisuseMoreThan5YearsAgo]
      ,rn.[Homeless]
      ,rn.[CurrentlyHomeless]
      ,rn.[HomelessInLast5Years]
      ,rn.[HomelessMoreThan5YearsAgo]
      ,rn.[Prison]
      ,rn.[CurrentlyInPrisonOrInPrisonWhenFirstSeen]
      ,rn.[InPrisonInLast5Years]
      ,rn.[InPrisonMoreThan5YearsAgo]
      ,rn.[TravelledOutsideUk]
      ,rn.[ToHowManyCountries]
      ,rn.[TravelCountry1]
      ,rn.[MonthsTravelled1]
      ,rn.[TravelCountry2]
      ,rn.[MonthsTravelled2]
      ,rn.[TravelCountry3]
      ,rn.[MonthsTravelled3]
      ,rn.[ReceivedVisitors]
      ,rn.[FromHowManyCountries]
      ,rn.[VisitorCountry1]
      ,rn.[DaysVisitorsStayed1]
      ,rn.[VisitorCountry2]
      ,rn.[DaysVisitorsStayed2]
      ,rn.[VisitorCountry3]
      ,rn.[DaysVisitorsStayed3]
      ,rn.[Diabetes]
      ,rn.[HepatitisB]
      ,rn.[HepatitisC]
      ,rn.[ChronicLiverDisease]
      ,rn.[ChronicRenalDisease]
      ,rn.[ImmunoSuppression]
      ,rn.[BiologicalTherapy]
      ,rn.[Transplantation]
      ,rn.[OtherImmunoSuppression]
      ,rn.[CurrentSmoker]
      ,rn.[PostMortemDiagnosis]
      ,rn.[DidNotStartTreatment]
      ,rn.[ShortCourse]
      ,rn.[MdrTreatment]
      ,rn.[MdrTreatmentDate]
      ,rn.[TreatmentOutcome12months]
      ,rn.[TreatmentOutcome24months]
      ,rn.[TreatmentOutcome36months]
      ,rn.[LastRecordedTreatmentOutcome]
      ,rn.[DateOfDeath]
      ,rn.[TreatmentEndDate]
      ,rn.[NoSampleTaken]
      ,rn.[CulturePositive]
      ,rn.[Species]
      ,rn.[EarliestSpecimenDate]
      ,rn.[DrugResistanceProfile]
      ,rn.[INH]
      ,rn.[RIF]
      ,rn.[EMB]
      ,rn.[PZA]
      ,rn.[AMINO]
      ,rn.[QUIN]
      ,rn.[MDR]
      ,rn.[XDR]
      ,rn.[DataRefreshedAt]
	FROM
		[dbo].[ReusableNotification] rn
		INNER JOIN [$(NTBS)].[dbo].[Notification] n ON n.NotificationId = rn.NotificationId
			AND rn.SourceSystem = 'NTBS'
			AND n.NotificationStatus = 'Denotified'
		INNER JOIN [$(NTBS)].[dbo].[DenotificationDetails] dn ON dn.NotificationId = rn.NotificationId
		LEFT OUTER JOIN [dbo].[DenotificationReasonMapping] drm ON drm.Reason = dn.Reason

    --then add the ETS records
    INSERT INTO [dbo].[DenotifiedRecords]
	([NotificationId]
      ,[NtbsId]
      ,[EtsId]
      ,[SourceSystem]
      ,[LtbrId]
      ,[NotificationDate]
      ,[Denotified]
      ,[DenotificationDate]
      ,[DenotificationReason]
      ,[CaseManager]
      ,[Consultant]
      ,[HospitalId]
      ,[Hospital]
      ,[TBServiceCode]
      ,[Service]
      ,[NhsNumber]
      ,[Forename]
      ,[Surname]
      ,[DateOfBirth]
      ,[Age]
      ,[Sex]
      ,[UkBorn]
      ,[EthnicGroup]
      ,[Occupation]
      ,[OccupationCategory]
      ,[BirthCountry]
      ,[UkEntryYear]
      ,[Postcode]
      ,[NoFixedAbode]
      ,[LocalAuthority]
      ,[LocalAuthorityCode]
      ,[ResidencePhecCode]
      ,[ResidencePhec]
      ,[TreatmentPhecCode]
      ,[TreatmentPhec]
      ,[SymptomOnsetDate]
      ,[PresentedDate]
      ,[OnsetToPresentationDays]
      ,[DiagnosisDate]
      ,[PresentationToDiagnosisDays]
      ,[StartOfTreatmentDate]
      ,[DiagnosisToTreatmentDays]
      ,[OnsetToTreatmentDays]
      ,[HivTestOffered]
      ,[SiteOfDisease]
      ,[AdultContactsIdentified]
      ,[ChildContactsIdentified]
      ,[TotalContactsIdentified]
      ,[AdultContactsAssessed]
      ,[ChildContactsAssessed]
      ,[TotalContactsAssessed]
      ,[AdultContactsActiveTB]
      ,[ChildContactsActiveTB]
      ,[TotalContactsActiveTB]
      ,[AdultContactsLTBI]
      ,[ChildContactsLTBI]
      ,[TotalContactsLTBI]
      ,[AdultContactsLTBITreat]
      ,[ChildContactsLTBITreat]
      ,[TotalContactsLTBITreat]
      ,[AdultContactsLTBITreatComplete]
      ,[ChildContactsLTBITreatComplete]
      ,[TotalContactsLTBITreatComplete]
      ,[PreviouslyDiagnosed]
      ,[YearsSinceDiagnosis]
      ,[PreviouslyTreated]
      ,[TreatmentInUk]
      ,[PreviousId]
      ,[BcgVaccinated]
      ,[AnySocialRiskFactor]
      ,[AlcoholMisuse]
      ,[DrugMisuse]
      ,[CurrentDrugMisuse]
      ,[DrugMisuseInLast5Years]
      ,[DrugMisuseMoreThan5YearsAgo]
      ,[Homeless]
      ,[CurrentlyHomeless]
      ,[HomelessInLast5Years]
      ,[HomelessMoreThan5YearsAgo]
      ,[Prison]
      ,[CurrentlyInPrisonOrInPrisonWhenFirstSeen]
      ,[InPrisonInLast5Years]
      ,[InPrisonMoreThan5YearsAgo]
      ,[TravelledOutsideUk]
      ,[ToHowManyCountries]
      ,[TravelCountry1]
      ,[MonthsTravelled1]
      ,[TravelCountry2]
      ,[MonthsTravelled2]
      ,[TravelCountry3]
      ,[MonthsTravelled3]
      ,[ReceivedVisitors]
      ,[FromHowManyCountries]
      ,[VisitorCountry1]
      ,[DaysVisitorsStayed1]
      ,[VisitorCountry2]
      ,[DaysVisitorsStayed2]
      ,[VisitorCountry3]
      ,[DaysVisitorsStayed3]
      ,[Diabetes]
      ,[HepatitisB]
      ,[HepatitisC]
      ,[ChronicLiverDisease]
      ,[ChronicRenalDisease]
      ,[ImmunoSuppression]
      ,[BiologicalTherapy]
      ,[Transplantation]
      ,[OtherImmunoSuppression]
      ,[CurrentSmoker]
      ,[PostMortemDiagnosis]
      ,[DidNotStartTreatment]
      ,[ShortCourse]
      ,[MdrTreatment]
      ,[MdrTreatmentDate]
      ,[TreatmentOutcome12months]
      ,[TreatmentOutcome24months]
      ,[TreatmentOutcome36months]
      ,[LastRecordedTreatmentOutcome]
      ,[DateOfDeath]
      ,[TreatmentEndDate]
      ,[NoSampleTaken]
      ,[CulturePositive]
      ,[Species]
      ,[EarliestSpecimenDate]
      ,[DrugResistanceProfile]
      ,[INH]
      ,[RIF]
      ,[EMB]
      ,[PZA]
      ,[AMINO]
      ,[QUIN]
      ,[MDR]
      ,[XDR]
      ,[DataRefreshedAt])
	SELECT 
       rn.NotificationId 
      ,rn.[NtbsId]
      ,rn.[EtsId]
      ,rn.[SourceSystem]
      ,rn.[LtbrId]
      ,rn.[NotificationDate]
      ,'Yes' AS 'Denotified' 
      ,dn.DenotificationDate    AS 'DenotificationDate'
      ,dn.Comments              AS 'DenotificationReason'
      ,rn.[CaseManager]
      ,rn.[Consultant]
      ,rn.[HospitalId]
      ,rn.[Hospital]
      ,rn.[TBServiceCode]
      ,rn.[Service]
      ,rn.[NhsNumber]
      ,rn.[Forename]
      ,rn.[Surname]
      ,rn.[DateOfBirth]
      ,rn.[Age]
      ,rn.[Sex]
      ,rn.[UkBorn]
      ,rn.[EthnicGroup]
      ,rn.[Occupation]
      ,rn.[OccupationCategory]
      ,rn.[BirthCountry]
      ,rn.[UkEntryYear]
      ,rn.[Postcode]
      ,rn.[NoFixedAbode]
      ,rn.[LocalAuthority]
      ,rn.[LocalAuthorityCode]
      ,rn.[ResidencePhecCode]
      ,rn.[ResidencePhec]
      ,rn.[TreatmentPhecCode]
      ,rn.[TreatmentPhec]
      ,rn.[SymptomOnsetDate]
      ,rn.[PresentedDate]
      ,rn.[OnsetToPresentationDays]
      ,rn.[DiagnosisDate]
      ,rn.[PresentationToDiagnosisDays]
      ,rn.[StartOfTreatmentDate]
      ,rn.[DiagnosisToTreatmentDays]
      ,rn.[OnsetToTreatmentDays]
      ,rn.[HivTestOffered]
      ,rn.[SiteOfDisease]
      ,rn.[AdultContactsIdentified]
      ,rn.[ChildContactsIdentified]
      ,rn.[TotalContactsIdentified]
      ,rn.[AdultContactsAssessed]
      ,rn.[ChildContactsAssessed]
      ,rn.[TotalContactsAssessed]
      ,rn.[AdultContactsActiveTB]
      ,rn.[ChildContactsActiveTB]
      ,rn.[TotalContactsActiveTB]
      ,rn.[AdultContactsLTBI]
      ,rn.[ChildContactsLTBI]
      ,rn.[TotalContactsLTBI]
      ,rn.[AdultContactsLTBITreat]
      ,rn.[ChildContactsLTBITreat]
      ,rn.[TotalContactsLTBITreat]
      ,rn.[AdultContactsLTBITreatComplete]
      ,rn.[ChildContactsLTBITreatComplete]
      ,rn.[TotalContactsLTBITreatComplete]
      ,rn.[PreviouslyDiagnosed]
      ,rn.[YearsSinceDiagnosis]
      ,rn.[PreviouslyTreated]
      ,rn.[TreatmentInUk]
      ,rn.[PreviousId]
      ,rn.[BcgVaccinated]
      ,rn.[AnySocialRiskFactor]
      ,rn.[AlcoholMisuse]
      ,rn.[DrugMisuse]
      ,rn.[CurrentDrugMisuse]
      ,rn.[DrugMisuseInLast5Years]
      ,rn.[DrugMisuseMoreThan5YearsAgo]
      ,rn.[Homeless]
      ,rn.[CurrentlyHomeless]
      ,rn.[HomelessInLast5Years]
      ,rn.[HomelessMoreThan5YearsAgo]
      ,rn.[Prison]
      ,rn.[CurrentlyInPrisonOrInPrisonWhenFirstSeen]
      ,rn.[InPrisonInLast5Years]
      ,rn.[InPrisonMoreThan5YearsAgo]
      ,rn.[TravelledOutsideUk]
      ,rn.[ToHowManyCountries]
      ,rn.[TravelCountry1]
      ,rn.[MonthsTravelled1]
      ,rn.[TravelCountry2]
      ,rn.[MonthsTravelled2]
      ,rn.[TravelCountry3]
      ,rn.[MonthsTravelled3]
      ,rn.[ReceivedVisitors]
      ,rn.[FromHowManyCountries]
      ,rn.[VisitorCountry1]
      ,rn.[DaysVisitorsStayed1]
      ,rn.[VisitorCountry2]
      ,rn.[DaysVisitorsStayed2]
      ,rn.[VisitorCountry3]
      ,rn.[DaysVisitorsStayed3]
      ,rn.[Diabetes]
      ,rn.[HepatitisB]
      ,rn.[HepatitisC]
      ,rn.[ChronicLiverDisease]
      ,rn.[ChronicRenalDisease]
      ,rn.[ImmunoSuppression]
      ,rn.[BiologicalTherapy]
      ,rn.[Transplantation]
      ,rn.[OtherImmunoSuppression]
      ,rn.[CurrentSmoker]
      ,rn.[PostMortemDiagnosis]
      ,rn.[DidNotStartTreatment]
      ,rn.[ShortCourse]
      ,rn.[MdrTreatment]
      ,rn.[MdrTreatmentDate]
      ,rn.[TreatmentOutcome12months]
      ,rn.[TreatmentOutcome24months]
      ,rn.[TreatmentOutcome36months]
      ,rn.[LastRecordedTreatmentOutcome]
      ,rn.[DateOfDeath]
      ,rn.[TreatmentEndDate]
      ,rn.[NoSampleTaken]
      ,rn.[CulturePositive]
      ,rn.[Species]
      ,rn.[EarliestSpecimenDate]
      ,rn.[DrugResistanceProfile]
      ,rn.[INH]
      ,rn.[RIF]
      ,rn.[EMB]
      ,rn.[PZA]
      ,rn.[AMINO]
      ,rn.[QUIN]
      ,rn.[MDR]
      ,rn.[XDR]
      ,rn.[DataRefreshedAt]
	FROM
		[dbo].[ReusableNotification] rn
		INNER JOIN [$(ETS)].[dbo].[Notification] n ON n.LegacyId = rn.NotificationId
			AND rn.SourceSystem = 'ETS'
			AND n.DenotificationId IS NOT NULL
		INNER JOIN [$(ETS)].[dbo].[Denotification] dn ON dn.Id = n.DenotificationId


    --and then remove these records from the ReusableNotification table
    DELETE FROM [dbo].[ReusableNotification] WHERE NotificationId IN 
        (SELECT NotificationID FROM [dbo].[DenotifiedRecords])
END TRY
BEGIN CATCH
	THROW
END CATCH


RETURN 0
